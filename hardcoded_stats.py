from typing import List
import subprocess
import random
import sys
import copy
import numpy
import concurrent.futures
from math import sqrt

__author__ = 'Miguel Arieiro'

#directory = "/home/ubuntu/critical_iot/tests/"
directory = ""
verbose = True

#parameters
pop_size = 25
number_generations = 5
runs_per_scen = 5
elite_per = 0.3
random_per = 0.2
minimum_throughput = 0.0
mutation_prob = 0.3


best_per_gen = list()
avg_per_gen = list()
diversity = list()
avgBest = 0
stdBest = 0
avgGen = 0
stdGen = 0
avgDiversity = 0
stdDiversity = 0
maxFit = 0
minFit = 0
genMin = 0
genMax = 0

def hamming_distance(v1, v2):
    return sum([1 for i in range (len(v1)-1) if v1[i] != v2 [i]]) # heuristic = v[-1]

def euclidean_distance(v1, v2):
    pairs = list(zip(v1[:-1], v2[:-1]))
    return sqrt(sum([(pair[0] - pair[1])**2 for pair in pairs])) # heuristic = v[-1]

def reset_stats():
    global best_per_gen
    global avg_per_gen
    global diversity
    global avgBest
    global stdBest
    global avgGen
    global stdGen
    global maxFit
    global minFit
    global genMin
    global genMax
    global avgDiversity
    global stdDiversity

    best_per_gen = list()
    avg_per_gen = list()
    diversity = list()
    avgBest = 0
    stdBest = 0
    avgGen = 0
    stdGen = 0
    avgDiversity = 0
    stdDiversity = 0
    maxFit = 0
    minFit = 0
    genMin = 0
    genMax = 0

def update_stats(population, metric=hamming_distance):

    global best_per_gen
    global avg_per_gen
    global diversity
    global pop_size

    population.sort(key=lambda x: x[-1])
    best_per_gen.append(population[0][-1])
    avg_per_gen.append(sum([f[-1] for f in population]) / len(population))
    
    div=0
    for i in range (len(population)):
        for j in range (i+1, pop_size):
            distance = metric(population[i], population[j])
            if distance !=0:
                div+=1
    
    diversity.append(div)
    

def calculate_stats():

    global best_per_gen
    global avg_per_gen
    global diversity
    global avgBest
    global stdBest
    global avgGen
    global stdGen
    global maxFit
    global minFit
    global genMin
    global genMax
    global avgDiversity
    global stdDiversity
    
    avgBest = numpy.mean(best_per_gen)
    stdBest = numpy.std(best_per_gen)
    avgGen = numpy.mean(avg_per_gen)
    stdGen = numpy.std(avg_per_gen)
    maxFit = max(best_per_gen)
    minFit = min(best_per_gen)
    genMax = best_per_gen.index(maxFit)
    genMin = best_per_gen.index(minFit)
    avgDiversity = numpy.mean(diversity)
    stdDiversity = numpy.std(diversity)

def stats_string():
    global best_per_gen
    global avg_per_gen
    global diversity
    global avgBest
    global stdBest
    global avgGen
    global stdGen
    global maxFit
    global minFit
    global genMin
    global genMax
    
    string = '\nMédia: {}'.format(str(avg_per_gen))
    string += '\nDiversidade: {}'.format(str(diversity))
    string += '\nMáximo do melhor: {} -> geração: {}/{}'.format(maxFit, genMax, number_generations)
    string += '\nMínimo do melhor: {} -> geração: {}/{}'.format(minFit, genMin, number_generations)
    string += '\nMédia do melhor: {} +- {}'.format(avgBest, stdBest)
    string += '\nMédia geracional: {} +- {}'.format(avgGen, stdGen)
    string += '\nDiversidade média: {} +- {}'.format(avgDiversity, stdDiversity)
    return string
    
def main():
    global pop_size
    global number_generations
    global elite_per
    global random_per
    global minimum_throughput
    #global scenario
    global runs_per_scen
    global directory
    metric = hamming_distance
    mutation_op = "mutate_prob"

    reset_stats()
    count=0
    num_scen=0

    filename = "%d_%d_%d_%.2f_%.2f_%s_%.2f.log" % (pop_size, number_generations, runs_per_scen, elite_per, random_per, mutation_op, mutation_prob)
    file_path = directory + filename
    file = open(file_path, "w")
    file.write("[technology, frequency, channelWidth, useUDP, useRts, guardInterval, enableObssPd, useExtendedBlockAck, mcs]\n")


    all_pop=[[[0, 6, 160, 1, 0, 1600, 0, 0, 7, 1.0360888856560955e-05], [0, 5, 80, 0, 1, 3200, 1, 1, 2, 2.5743267333792873e-06], [0, 6, 80, 0, 1, 1600, 1, 0, 0, 2.6611601023666343e-06], [0, 5, 40, 1, 1, 1600, 0, 1, 0, 3.0509852122469984e-06], [1, 5, 20, 0, 1, 0, 1, 0, 6, 8.262948554404926e-06], [0, 5, 20, 0, 1, 3200, 1, 0, 1, 1.0], [1, 5, 160, 0, 1, 1, 0, 1, 20, 8.244909278187149e-06], [0, 6, 40, 1, 1, 3200, 1, 0, 11, 1.0768402676752983e-05], [0, 6, 20, 0, 0, 1600, 0, 1, 7, 9.812408682947193e-06], [0, 6, 160, 1, 0, 3200, 0, 1, 8, 1.0373290660459704e-05], [0, 5, 80, 1, 0, 800, 0, 1, 4, 2.698413103703609e-06], [0, 5, 40, 0, 1, 3200, 0, 1, 8, 9.992242398942461e-06], [1, 5, 80, 0, 0, 1, 0, 1, 16, 8.344834689463386e-06], [0, 6, 80, 1, 1, 1600, 1, 1, 11, 1.0735543351760255e-05], [1, 5, 80, 0, 1, 1, 0, 0, 6, 8.262948554404926e-06], [1, 5, 20, 0, 1, 1, 0, 1, 6, 8.262948554404926e-06], [1, 5, 160, 0, 1, 0, 1, 1, 23, 8.234042721769721e-06], [1, 5, 80, 0, 1, 0, 1, 0, 19, 8.253399150608518e-06], [1, 5, 20, 1, 1, 0, 0, 1, 14, 8.886567494425817e-06], [1, 5, 80, 0, 1, 1, 0, 1, 4, 8.285848974385383e-06], [0, 6, 40, 0, 0, 3200, 0, 1, 5, 3.2183788455997694e-06], [0, 6, 160, 0, 1, 1600, 0, 0, 11, 1.0224048563278369e-05], [0, 6, 160, 0, 0, 1600, 1, 0, 3, 2.495463914112359e-06], [0, 5, 160, 1, 1, 800, 1, 0, 7, 1.054453375036369e-05], [0, 5, 160, 0, 1, 800, 1, 0, 0, 2.6581186761641406e-06]],
            [[0, 6, 20, 0, 1, 1600, 0, 0, 4, 2.534665821480924e-06], [0, 6, 80, 0, 1, 3200, 1, 0, 4, 2.5493467185382976e-06], [0, 6, 20, 0, 1, 1600, 0, 0, 1, 2.556548609460423e-06], [0, 6, 20, 0, 1, 1600, 0, 0, 1, 2.556548609460423e-06], [0, 6, 20, 1, 0, 3200, 1, 1, 0, 2.8008169691296303e-06], [0, 6, 80, 1, 1, 1600, 1, 0, 3, 2.8792633160141107e-06], [0, 6, 80, 1, 1, 1600, 1, 0, 3, 2.8792633160141107e-06], [0, 5, 20, 1, 1, 3200, 1, 1, 3, 2.896026546413682e-06], [0, 5, 20, 1, 1, 3200, 1, 1, 3, 2.896026546413682e-06], [0, 6, 80, 1, 1, 800, 1, 1, 2, 2.9126973659018095e-06], [0, 6, 80, 1, 1, 800, 1, 1, 2, 2.9126973659018095e-06], [0, 5, 40, 1, 1, 3200, 1, 0, 1, 2.9242256637168142e-06], [0, 5, 40, 1, 1, 3200, 1, 0, 1, 2.9242256637168142e-06], [0, 5, 160, 1, 1, 3200, 0, 0, 0, 3.058160752338297e-06], [0, 5, 160, 1, 1, 3200, 0, 0, 0, 3.058160752338297e-06], [0, 6, 40, 1, 0, 3200, 0, 1, 5, 3.631451835495446e-06], [0, 6, 40, 1, 0, 3200, 0, 1, 5, 3.631451835495446e-06], [1, 5, 80, 0, 1, 0, 1, 0, 23, 8.234042721769721e-06], [1, 5, 20, 0, 0, 1, 1, 1, 4, 8.23422459893048e-06], [1, 5, 160, 0, 1, 1, 1, 0, 20, 8.244909278187149e-06], [1, 5, 40, 0, 1, 1, 0, 1, 11, 8.265960986895274e-06], [1, 5, 80, 0, 1, 0, 0, 1, 11, 8.265960986895274e-06], [1, 5, 20, 0, 1, 1, 0, 1, 11, 8.265960986895274e-06], [1, 5, 160, 1, 0, 0, 1, 1, 15, 8.819081578812996e-06], [1, 5, 80, 1, 1, 1, 1, 0, 17, 8.985546710461935e-06]],
            [[0, 6, 20, 0, 0, 1600, 1, 0, 4, 2.4001235976421374e-06], [0, 6, 20, 0, 0, 1600, 1, 0, 4, 2.4001235976421374e-06], [0, 6, 160, 0, 1, 1600, 1, 0, 3, 2.5289398621345376e-06], [0, 6, 160, 0, 1, 1600, 1, 0, 3, 2.5289398621345376e-06], [0, 6, 20, 0, 1, 3200, 1, 1, 4, 2.54173236456988e-06], [0, 6, 20, 0, 1, 3200, 1, 1, 4, 2.54173236456988e-06], [0, 6, 80, 0, 1, 1600, 1, 0, 1, 2.556548609460423e-06], [0, 6, 80, 0, 1, 1600, 1, 0, 1, 2.556548609460423e-06], [0, 5, 80, 0, 1, 3200, 0, 1, 0, 2.6733053365556042e-06], [0, 5, 20, 1, 0, 1600, 1, 0, 3, 2.6941623015484648e-06], [0, 5, 20, 1, 0, 1600, 1, 0, 3, 2.6941623015484648e-06], [0, 5, 20, 1, 0, 3200, 1, 1, 3, 2.706400507240518e-06], [0, 5, 20, 1, 0, 3200, 1, 1, 3, 2.706400507240518e-06], [0, 6, 20, 1, 0, 800, 0, 0, 2, 2.7115729098854153e-06], [0, 6, 20, 1, 0, 800, 0, 0, 2, 2.7115729098854153e-06], [0, 5, 40, 1, 1, 800, 1, 1, 3, 2.8689909318763058e-06], [0, 6, 80, 1, 1, 800, 1, 1, 2, 2.9126973659018095e-06], [0, 6, 80, 1, 1, 800, 0, 0, 0, 3.0384947563232572e-06], [1, 5, 160, 0, 0, 1, 0, 1, 19, 8.207707116882293e-06], [1, 5, 80, 0, 1, 1, 0, 0, 23, 8.234042721769721e-06], [1, 5, 160, 0, 1, 0, 1, 0, 20, 8.244909278187149e-06], [1, 5, 20, 1, 0, 0, 1, 1, 12, 8.832658167520553e-06], [1, 5, 40, 1, 1, 1, 1, 1, 19, 8.911791864715468e-06], [1, 5, 80, 1, 0, 0, 0, 1, 8, 9.026547919441384e-06], [0, 6, 40, 1, 0, 800, 0, 0, 8, 1.0355360779749781e-05]],
            [[0, 5, 80, 0, 0, 800, 1, 1, 4, 2.400289979083476e-06], [0, 5, 80, 0, 0, 800, 1, 1, 4, 2.400289979083476e-06], [0, 6, 80, 0, 0, 3200, 1, 1, 3, 2.4073435853556122e-06], [0, 6, 40, 0, 0, 3200, 0, 1, 3, 2.4073435853556122e-06], [0, 6, 80, 0, 0, 3200, 1, 1, 3, 2.4073435853556122e-06], [0, 6, 40, 0, 0, 3200, 0, 1, 3, 2.4073435853556122e-06], [0, 5, 160, 0, 1, 1600, 1, 1, 3, 2.5243601933285796e-06], [0, 5, 160, 0, 1, 1600, 1, 1, 3, 2.5243601933285796e-06], [0, 6, 20, 0, 1, 1600, 1, 0, 4, 2.534665821480924e-06], [0, 6, 20, 0, 1, 1600, 1, 0, 4, 2.534665821480924e-06], [0, 6, 160, 1, 0, 1600, 1, 1, 4, 2.7006885223578277e-06], [0, 6, 160, 1, 0, 1600, 1, 1, 4, 2.7006885223578277e-06], [0, 5, 40, 1, 0, 1600, 1, 1, 4, 2.7006885223578277e-06], [0, 5, 20, 1, 0, 3200, 0, 0, 3, 2.7061411720651564e-06], [0, 5, 20, 1, 0, 3200, 0, 0, 3, 2.7061411720651564e-06], [0, 6, 40, 1, 0, 3200, 1, 0, 3, 2.7061411720651564e-06], [0, 5, 20, 1, 0, 3200, 1, 0, 4, 2.7089345514427108e-06], [0, 6, 20, 1, 0, 800, 0, 0, 2, 2.7115729098854153e-06], [0, 6, 40, 1, 0, 800, 1, 1, 2, 2.711688786951656e-06], [0, 5, 160, 1, 0, 3200, 1, 1, 0, 2.8008169691296303e-06], [0, 5, 20, 1, 1, 1600, 1, 0, 3, 2.8792633160141107e-06], [0, 6, 20, 1, 1, 800, 1, 0, 2, 2.9109772337592164e-06], [0, 6, 80, 0, 0, 3200, 1, 0, 8, 9.822879705002435e-06], [0, 5, 40, 0, 0, 800, 0, 0, 11, 1.0018298198010157e-05], [1, 5, 40, 0, 0, 0, 0, 1, 23, 1.7791533408989307e-05]],
            [[0, 5, 80, 0, 0, 3200, 0, 0, 4, 2.406987062169721e-06], [0, 5, 80, 0, 0, 3200, 0, 0, 4, 2.406987062169721e-06], [0, 5, 160, 0, 0, 3200, 0, 1, 3, 2.4073435853556122e-06], [0, 5, 160, 0, 0, 3200, 0, 1, 3, 2.4073435853556122e-06], [0, 5, 160, 0, 0, 800, 1, 0, 0, 2.4636380202349922e-06], [0, 5, 160, 0, 0, 800, 1, 0, 0, 2.4636380202349922e-06], [0, 6, 160, 0, 1, 800, 1, 1, 3, 2.520965058236273e-06], [0, 6, 160, 0, 1, 800, 1, 1, 3, 2.520965058236273e-06], [0, 5, 20, 0, 1, 1600, 1, 0, 4, 2.534665821480924e-06], [0, 5, 20, 0, 1, 1600, 1, 0, 4, 2.534665821480924e-06], [0, 6, 20, 1, 0, 800, 1, 1, 3, 2.6882872072440086e-06], [0, 6, 20, 1, 0, 800, 1, 1, 3, 2.6882872072440086e-06], [0, 5, 160, 1, 0, 1600, 0, 0, 3, 2.6941623015484648e-06], [0, 5, 160, 1, 0, 1600, 0, 0, 3, 2.6941623015484648e-06], [0, 6, 160, 1, 0, 800, 1, 1, 4, 2.698413103703609e-06], [0, 6, 20, 1, 0, 3200, 0, 1, 3, 2.706400507240518e-06], [0, 6, 160, 1, 0, 3200, 1, 1, 4, 2.709134001668e-06], [0, 5, 80, 1, 0, 800, 1, 0, 2, 2.7115729098854153e-06], [0, 6, 40, 1, 0, 800, 1, 0, 2, 2.7115729098854153e-06], [0, 5, 40, 1, 1, 1600, 0, 1, 4, 2.8860805814047496e-06], [0, 5, 20, 1, 1, 800, 0, 0, 1, 2.9077505063743595e-06], [1, 5, 40, 0, 1, 1, 1, 0, 23, 8.234042721769721e-06], [1, 5, 40, 0, 0, 0, 0, 1, 2, 8.295688617061731e-06], [1, 5, 160, 1, 1, 0, 1, 1, 9, 9.06455717209714e-06], [0, 6, 160, 0, 1, 1600, 0, 0, 7, 9.975579211020663e-06]],
            [[0, 5, 20, 0, 0, 1600, 0, 1, 4, 2.399169716848093e-06], [0, 5, 20, 0, 0, 1600, 0, 1, 4, 2.399169716848093e-06], [0, 5, 160, 0, 1, 800, 1, 1, 3, 2.520965058236273e-06], [0, 5, 160, 0, 1, 800, 1, 1, 3, 2.520965058236273e-06], [0, 5, 160, 0, 1, 3200, 1, 1, 3, 2.5446834640678233e-06], [0, 6, 20, 0, 1, 3200, 0, 1, 3, 2.5446834640678233e-06], [0, 5, 160, 0, 1, 3200, 1, 1, 3, 2.5446834640678233e-06], [0, 6, 20, 0, 1, 3200, 0, 1, 3, 2.5446834640678233e-06], [0, 5, 80, 0, 1, 800, 0, 0, 0, 2.6581186761641406e-06], [0, 5, 40, 0, 1, 800, 1, 0, 0, 2.6581186761641406e-06], [0, 5, 80, 0, 1, 800, 0, 0, 0, 2.6581186761641406e-06], [0, 5, 40, 0, 1, 800, 1, 0, 0, 2.6581186761641406e-06], [0, 6, 160, 0, 1, 800, 1, 0, 0, 2.6581186761641406e-06], [0, 5, 20, 1, 0, 800, 1, 1, 3, 2.6882872072440086e-06], [0, 5, 20, 1, 0, 800, 1, 1, 3, 2.6882872072440086e-06], [0, 5, 20, 1, 0, 1600, 0, 1, 4, 2.7006885223578277e-06], [0, 5, 20, 1, 0, 1600, 0, 1, 4, 2.7006885223578277e-06], [0, 5, 20, 1, 0, 800, 1, 0, 2, 2.7115729098854153e-06], [0, 5, 160, 1, 1, 3200, 1, 1, 4, 2.900442073105872e-06], [0, 6, 80, 1, 1, 3200, 0, 0, 2, 2.9319161246134012e-06], [1, 5, 80, 0, 0, 1, 1, 0, 13, 8.193175786479913e-06], [1, 5, 80, 0, 0, 1, 1, 0, 10, 8.244406946160915e-06], [1, 5, 20, 0, 0, 1, 1, 1, 3, 8.27082442046553e-06], [1, 5, 20, 1, 1, 0, 0, 0, 6, 8.909142742865409e-06], [1, 5, 40, 1, 1, 1, 1, 1, 0, 9.391492956072548e-06]]]

    run = 0
    for population in all_pop:
        

        if (count == runs_per_scen):
            num_scen+=1
            #current_scen=scenario[num_scen]
            count=0
            print("Scenario: %d" % num_scen)

        if verbose:
            run += 1
            print("Run: %d\t Scenario: %d" % (run, num_scen))

        if verbose:
            print(population)

        update_stats(population, metric)
        file.write(str(population)+'\n')
        count+=1

    calculate_stats()

    if verbose:
        print(stats_string())
    
    file.write(stats_string()+'\n')

    file.close()
if __name__ == "__main__":
    main()
